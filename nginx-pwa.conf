# Nginx Configuration for PWA (Progressive Web App)
# 
# This configuration ensures proper serving of PWA assets including:
# - Service Worker files
# - Web App Manifest
# - PWA icons
# - Correct MIME types
# - Cache headers for optimal performance
#
# Usage:
#   Include this file in your main nginx.conf or site configuration
#   Example: include /path/to/nginx-pwa.conf;

# Service Worker Configuration
# Service workers must be served with correct headers and MIME type
location ~* ^/sw\.js$ {
    add_header Cache-Control "public, max-age=0, must-revalidate";
    add_header Service-Worker-Allowed "/";
    add_header Content-Type "application/javascript; charset=utf-8";
    add_header X-Content-Type-Options "nosniff";
    
    # Security headers
    add_header X-Frame-Options "DENY";
    add_header X-XSS-Protection "1; mode=block";
    
    # CORS headers for service worker
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, OPTIONS";
    
    # Prevent caching of service worker
    expires -1;
    etag off;
    if_modified_since off;
}

# Workbox files (service worker dependencies)
location ~* ^/workbox-.*\.js$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Content-Type "application/javascript; charset=utf-8";
    expires 1y;
    access_log off;
}

# Web App Manifest
location = /manifest.json {
    add_header Cache-Control "public, max-age=86400, stale-while-revalidate";
    add_header Content-Type "application/manifest+json; charset=utf-8";
    add_header X-Content-Type-Options "nosniff";
    
    # CORS headers
    add_header Access-Control-Allow-Origin "*";
    
    expires 1d;
    access_log off;
}

# PWA Icons - Cache aggressively
location ~* ^/icons/.*\.(png|jpg|jpeg|gif|ico|svg|webp)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff";
    
    # CORS headers
    add_header Access-Control-Allow-Origin "*";
    
    expires 1y;
    access_log off;
}

# Offline page
location = /offline {
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff";
    expires 1y;
    access_log off;
    
    try_files /offline.html /offline/index.html =404;
}

# Static assets (JS, CSS, images, fonts)
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff";
    
    # CORS headers for cross-origin resources
    add_header Access-Control-Allow-Origin "*";
    
    expires 1y;
    access_log off;
}

# Next.js static files
location /_next/static/ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    expires 1y;
    access_log off;
}

# Next.js image optimization
location /_next/image {
    add_header Cache-Control "public, max-age=86400, stale-while-revalidate";
    expires 1d;
}

# API routes - Don't cache mutations, cache GET requests appropriately
location ~* ^/api/ {
    # Don't cache POST, PUT, DELETE, PATCH
    if ($request_method ~ ^(POST|PUT|DELETE|PATCH)$) {
        add_header Cache-Control "no-store, no-cache, must-revalidate, private";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # Cache GET requests with appropriate headers
    if ($request_method = GET) {
        add_header Cache-Control "public, max-age=3600, stale-while-revalidate=86400";
    }
    
    # CORS headers for API
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH";
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
    add_header Access-Control-Allow-Credentials "true";
    add_header Access-Control-Max-Age "86400";
    
    # Handle preflight requests
    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
        add_header Access-Control-Max-Age "86400";
        add_header Content-Length "0";
        add_header Content-Type "text/plain";
        return 204;
    }
    
    # Security headers
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "DENY";
    add_header X-XSS-Protection "1; mode=block";
    
    # Proxy to backend (adjust proxy_pass to your backend URL)
    # proxy_pass http://localhost:4001;
    # proxy_http_version 1.1;
    # proxy_set_header Upgrade $http_upgrade;
    # proxy_set_header Connection 'upgrade';
    # proxy_set_header Host $host;
    # proxy_cache_bypass $http_upgrade;
}

# HTTPS enforcement (uncomment in production)
# if ($scheme != "https") {
#     return 301 https://$host$request_uri;
# }

# Security headers for all responses
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# HSTS (HTTP Strict Transport Security) - Uncomment in production with HTTPS
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy (adjust as needed)
# add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-ancestors 'none';" always;

